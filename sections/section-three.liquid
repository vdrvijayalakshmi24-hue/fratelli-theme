{% comment %}
  sections/section-three.liquid
  - Minimal visual markup; added robust video preload + retry + fallback logic.
{% endcomment %}

<section id="section-three-{{ section.id }}" class="section-three">
    <style>
      .section-three {
        position: relative;
      }
      .section-three_content {
        position: absolute;
        width: 100%;
        height: 70vh;
        transform: rotate(180deg);
        background: linear-gradient(0deg, #030202 74.46%, rgba(0, 0, 0, 0) 100%);
        z-index: 2;
      }
      .section-three_content-bottom-inner {
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        height: 100%;
        padding: 0 20px 50px 20px;
      }
      .section-three_content-bottom {
        width: 100%;
        height: 70vh;
        background: linear-gradient(0deg, #030202 74.46%, rgba(0, 0, 0, 0) 100%);
        position: relative;
        z-index: 2;
      }
  
      /* Underlay container (we’ll sticky its child video/canvas) */
      .section-three-video-wine-mobile {
        position: relative;
        z-index: 0 !important;     /* ensure presence even before JS runs */
      }
  
      .section-three-video-wine-mobile video,
      .section-three-video-wine-mobile canvas {
        z-index: 0;
        position: relative; /* or sticky/top:0 if you want it to stick */
        top: 80% !important;
      }
      .section-three-wine-mobile-h1 {
        font-family: "Utile", sans-serif; color: #ffffff;
        font-size: 36px; font-weight: 600;
      }
      .section-three-wine-mobile-p {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #FFFFF8; font-size: 16px; letter-spacing: -0.04em;
      }
      .section-three-wine-mobile-wine-btn {
        background: #fff; color: #000; border: none; padding: 0.625rem 1.25rem;
        border-radius: 20px; font-weight: 600; cursor: pointer;
      }
      .section-three-video-wine-mobile {
        overflow: unset !important;
      }
  
      /* small helper to hide the warmup video */
      .section-three-warmup-video {
        width: 1px;
        height: 1px;
        opacity: 0;
        position: absolute;
        pointer-events: none;
        left: -9999px;
      }
    </style>
  
    <div class="section-three_content"></div>
    <div id="scrolly-video4-wine-mobile-{{ section.id }}" class="section-three-video-wine-mobile"></div>
  
    <div class="section-three_content-bottom">
      <div class="section-three_content-bottom-inner" id="section-three-inner-wine-mobile-{{ section.id }}">
        <h1 class="section-three-wine-mobile-h1" id="section-three-h1-wine-mobile-{{ section.id }}">Pour more into every moment</h1>
        <p class="section-three-wine-mobile-p" id="section-three-p1-wine-mobile-{{ section.id }}">
          Be it a quiet evening or a grand celebration, our wines bring richness and artistry to every occasion because there’s something for everyone
        </p>
        <div style="margin-top: 1.25rem;">
          <button type="button" class="section-three-wine-mobile-wine-btn" tabindex="-1">EXPLORE OUR RANGE</button>
        </div>
      </div>
    </div>
  
    <script>
      (function () {
        var sectionId   = "{{ section.id }}";
        var containerId = "scrolly-video4-wine-mobile-" + sectionId;
  
        // video source + poster (poster optional, add if you have one)
        var videoSrc = "https://cdn.shopify.com/videos/c/o/v/5a1e96ee8ce0416b9ab384b9c7b9be6e.mp4";
        var videoPoster = ""; // put poster URL here if you have one
  
        // --- Preload link helper ---
        function addPreloadLink(url) {
          try {
            if (!document.querySelector('link[data-sv-preload][href="' + url + '"]')) {
              var l = document.createElement('link');
              l.setAttribute('rel', 'preload');
              l.setAttribute('as', 'video');
              l.setAttribute('href', url);
              l.setAttribute('crossorigin', 'anonymous');
              l.setAttribute('data-sv-preload', '');
              document.head.appendChild(l);
            }
          } catch (e) {
            console.warn('[SV4] preload link failed', e);
          }
        }
  
        // --- Warmup video element creation (hidden) ---
        function createWarmupVideo(src, poster) {
          var v = document.createElement('video');
          v.className = 'section-three-warmup-video';
          v.preload = 'auto';
          v.muted = true;              // allow autoplay behavior in many browsers
          v.playsInline = true;
          v.crossOrigin = 'anonymous';
          if (poster) v.poster = poster;
          // Do not append controls
          v.setAttribute('aria-hidden', 'true');
          v.src = src;
          return v;
        }
  
        // --- Simple retry loader (tries to load metadata); returns a Promise ---
        function loadVideoWithRetries(videoEl, attempts) {
          attempts = attempts || 2;
          var attempt = 0;
  
          return new Promise(function (resolve, reject) {
            function tryOnce() {
              attempt++;
              var loaded = false;
  
              function cleanHandlers() {
                videoEl.removeEventListener('loadedmetadata', onLoaded);
                videoEl.removeEventListener('canplay', onCanPlay);
                videoEl.removeEventListener('error', onError);
                clearTimeout(timeout);
              }
              function onLoaded() {
                if (loaded) return;
                loaded = true;
                cleanHandlers();
                resolve({ type: 'loadedmetadata' });
              }
              function onCanPlay() {
                if (loaded) return;
                loaded = true;
                cleanHandlers();
                resolve({ type: 'canplay' });
              }
              function onError(e) {
                cleanHandlers();
                if (attempt <= attempts) {
                  var backoff = Math.pow(2, attempt) * 250; // exponential backoff
                  console.warn('[SV4] video load error; retrying in', backoff, 'ms', e);
                  setTimeout(tryOnce, backoff);
                } else {
                  reject(new Error('video failed to load after ' + attempts + ' attempts'));
                }
              }
  
              // Safety timeout if browser neither fires loadedmetadata nor error
              var timeout = setTimeout(function () {
                onError(new Error('video load timeout'));
              }, 8000);
  
              videoEl.addEventListener('loadedmetadata', onLoaded);
              videoEl.addEventListener('canplay', onCanPlay);
              videoEl.addEventListener('error', onError);
  
              // try loading by calling load()
              try {
                videoEl.load();
              } catch (e) {
                // some browsers may throw synchronously
                onError(e);
              }
            }
  
            tryOnce();
          });
        }
  
        // --- Initialize: we will observe the section and only preload when near viewport ---
        var sectionEl = document.getElementById('section-three-' + sectionId);
        var scrollyContainer = document.getElementById(containerId);
        var warmupVideo = null;
        var initializedScrolly = false;
  
        // If IntersectionObserver isn't available, just start immediately
        function onNearViewport() {
          if (initializedScrolly) return;
          initializedScrolly = true;
  
          addPreloadLink(videoSrc);
  
          // create warmup video and append to body (hidden)
          warmupVideo = createWarmupVideo(videoSrc, videoPoster);
          document.body.appendChild(warmupVideo);
  
          loadVideoWithRetries(warmupVideo, 2).then(function (res) {
            console.info('[SV4] warmup video ready:', res.type);
  
            // now initialize ScrollyVideo if present
            try {
              if (window.ScrollyVideo) {
                // give ScrollyVideo the container id and let it create its own video/canvas
                new ScrollyVideo({
                  scrollyVideoContainer: containerId,
                  src: videoSrc,
                  cover: true,
                  sticky: false,
                });
              } else {
                // fallback: insert the video element we warmed up into the container so at least it plays
                // make a clone so we don't move the warmup element (which may be used for caching)
                var fallbackVideo = warmupVideo.cloneNode(true);
                fallbackVideo.className = '';
                fallbackVideo.style.width = '100%';
                fallbackVideo.style.height = 'auto';
                fallbackVideo.autoplay = true;
                fallbackVideo.loop = true;
                fallbackVideo.muted = false; // let user toggle audio via UI if you add one
                scrollyContainer.appendChild(fallbackVideo);
                // attempt to play
                fallbackVideo.play().catch(function (e) {
                  console.warn('[SV4] fallback video play blocked (user gesture required):', e);
                });
              }
            } catch (err) {
              console.warn('[SV4] ScrollyVideo init failed; using fallback video', err);
            }
  
            // cleanup warmup video (remove but leave preloaded caches)
            try { warmupVideo.remove(); } catch (e) {}
            warmupVideo = null;
          }).catch(function (err) {
            console.error('[SV4] warmup video failed:', err);
            // final fallback: try to initialize ScrollyVideo anyway (it might handle streaming differently)
            try {
              if (window.ScrollyVideo) {
                new ScrollyVideo({
                  scrollyVideoContainer: containerId,
                  src: videoSrc,
                  cover: true,
                  sticky: false,
                });
              }
            } catch (e) {
              console.warn('[SV4] ScrollyVideo init after failure failed:', e);
            }
          });
  
          // Also run the GSAP fade logic (you had this further down)
          runInnerFade();
        }
  
        // IntersectionObserver to start preloading when section is near viewport (250px root margin)
        if ('IntersectionObserver' in window && sectionEl) {
          var io = new IntersectionObserver(function (entries) {
            entries.forEach(function (ent) {
              if (ent.isIntersecting) {
                onNearViewport();
                io.disconnect();
              }
            });
          }, { root: null, rootMargin: '250px', threshold: 0.01 });
          io.observe(sectionEl);
        } else {
          // no IO support -> immediate
          onNearViewport();
        }
  
        // --- GSAP inner fade (kept your original behavior; extracted into a function) ---
        function runInnerFade() {
          var innerSel = "#section-three-inner-wine-mobile-" + sectionId;
          var overlaySel = ".section-three_content-bottom";
          var overlayEl = document.querySelector(overlaySel);
          var innerEl = document.querySelector(innerSel);
          if (window.gsap && window.ScrollTrigger && innerEl) {
            try {
              gsap.registerPlugin(ScrollTrigger);
            } catch (e) { /* already registered */ }
  
            gsap.set(innerEl, { opacity: 0 });
  
            gsap.to(innerSel, {
              scrollTrigger: {
                trigger: overlayEl,
                start: 'top 40%',
                end: 'top 25%',
                scrub: false,
                markers: false,
                onEnter: function () {
                  gsap.to(innerSel, {
                    opacity: 1,
                    duration: 1.2,
                    ease: 'power2.out'
                  });
                },
                onLeaveBack: function () {
                  gsap.to(innerSel, {
                    opacity: 0,
                    duration: 0.6,
                    ease: 'power2.in'
                  });
                }
              }
            });
          } else {
            console.warn('[SV4] GSAP/ScrollTrigger missing — inner fade skipped.');
          }
        }
  
        // If the section is already in viewport on load, trigger now (safety)
        try {
          var rect = sectionEl && sectionEl.getBoundingClientRect && sectionEl.getBoundingClientRect();
          if (rect && rect.top < (window.innerHeight || document.documentElement.clientHeight) + 250) {
            // may be visible now — manually call
            onNearViewport();
          }
        } catch (e) { /* ignore */ }
  
        // Expose for debugging
        window._sv4_debug = window._sv4_debug || {};
        window._sv4_debug['{{ section.id }}'] = {
          src: videoSrc,
          containerId: containerId
        };
      })();
    </script>
  </section>
  
  {% schema %}
  {
    "name": "Section Three",
    "settings": [],
    "blocks": [],
    "presets": [
      {
        "name": "Section Three",
        "category": "Custom"
      }
    ]
  }
  {% endschema %}
  