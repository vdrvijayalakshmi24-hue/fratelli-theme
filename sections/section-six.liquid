{% comment %}
  sections/section-six.liquid
  - Minimal visual markup; added robust video preload + retry + fallback logic.
{% endcomment %}

<section id="section-six-{{ section.id }}" class="section-six">
    <style>
      .section-six {
        position: relative;
      }
      .section-six_content {
        position: absolute;
        width: 100%;
        height: 70vh;
        transform: rotate(180deg);
        background: linear-gradient(360deg, #A38C78 73.06%, rgba(201, 160, 133, 0) 100%);
        z-index: 2;
      }
      .section-six_content-bottom-inner {
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        height: 100%;
        padding: 0 20px 50px 20px;
      }
      .section-six_content-bottom {
        width: 100%;
        height: 70vh;
        background: linear-gradient(0deg, #825D39 74.46%, rgba(0, 0, 0, 0) 100%);
        position: relative;
        z-index: 2;
      }
  
      .section-six-video-wine-mobile {
        position: relative;
        z-index: 0 !important;
        overflow: unset !important;
      }
  
      .section-six-video-wine-mobile video,
      .section-six-video-wine-mobile canvas {
        z-index: 0;
        position: relative;
        top: 80% !important;
      }
      .section-six-wine-mobile-h1 {
        font-family: "Utile", sans-serif; color: #ffffff;
        font-size: 36px; font-weight: 600;
      }
      .section-six-wine-mobile-p {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #FFFFF8; font-size: 16px; letter-spacing: -0.04em;
      }
      .section-six-wine-mobile-wine-btn {
        background: #fff; color: #000; border: none; padding: 0.625rem 1.25rem;
        border-radius: 20px; font-weight: 600; cursor: pointer;
      }
  
      .section-six-warmup-video {
        width: 1px;
        height: 1px;
        opacity: 0;
        position: absolute;
        pointer-events: none;
        left: -9999px;
      }
    </style>
  
    <div class="section-six_content"></div>
    <div id="section-six-video-wine-mobile-{{ section.id }}" class="section-six-video-wine-mobile"></div>
  
    <div class="section-six_content-bottom">
      <div class="section-six_content-bottom-inner" id="section-six-inner-wine-mobile-{{ section.id }}">
        <h1 class="section-six-wine-mobile-h1" id="section-six-h1-wine-mobile-{{ section.id }}">Pour more into every moment</h1>
        <p class="section-six-wine-mobile-p" id="section-six-p1-wine-mobile-{{ section.id }}">
          Be it a quiet evening or a grand celebration, our wines bring richness and artistry to every occasion because thereâ€™s something for everyone
        </p>
        <div style="margin-top: 1.25rem;">
          <button type="button" class="section-six-wine-mobile-wine-btn" tabindex="-1">EXPLORE OUR RANGE</button>
        </div>
      </div>
    </div>
  
    <script>
      (function () {
        var sectionId   = "{{ section.id }}";
        var containerId = "section-six-video-wine-mobile-" + sectionId;
        var videoSrc    = "https://cdn.shopify.com/videos/c/o/v/25e8f24bf08841a6aaa2e57a7ad482f2.mp4";
        var videoPoster = ""; // optional poster
  
        function addPreloadLink(url) {
          if (!document.querySelector('link[data-sv-preload][href="' + url + '"]')) {
            var l = document.createElement('link');
            l.rel = 'preload';
            l.as = 'video';
            l.href = url;
            l.crossOrigin = 'anonymous';
            l.dataset.svPreload = 'true';
            document.head.appendChild(l);
          }
        }
  
        function createWarmupVideo(src, poster) {
          var v = document.createElement('video');
          v.className = 'section-six-warmup-video';
          v.preload = 'auto';
          v.muted = true;
          v.playsInline = true;
          v.crossOrigin = 'anonymous';
          if (poster) v.poster = poster;
          v.setAttribute('aria-hidden', 'true');
          v.src = src;
          return v;
        }
  
        function loadVideoWithRetries(videoEl, attempts) {
          attempts = attempts || 2;
          var attempt = 0;
  
          return new Promise(function (resolve, reject) {
            function tryOnce() {
              attempt++;
              var loaded = false;
  
              function clean() {
                videoEl.removeEventListener('loadedmetadata', onLoaded);
                videoEl.removeEventListener('canplay', onCanPlay);
                videoEl.removeEventListener('error', onError);
                clearTimeout(timeout);
              }
              function onLoaded() { if (!loaded) { loaded = true; clean(); resolve(); } }
              function onCanPlay() { if (!loaded) { loaded = true; clean(); resolve(); } }
              function onError(e) {
                clean();
                if (attempt <= attempts) {
                  var backoff = Math.pow(2, attempt) * 250;
                  setTimeout(tryOnce, backoff);
                } else reject(e);
              }
              var timeout = setTimeout(() => onError(new Error("timeout")), 8000);
              videoEl.addEventListener('loadedmetadata', onLoaded);
              videoEl.addEventListener('canplay', onCanPlay);
              videoEl.addEventListener('error', onError);
              try { videoEl.load(); } catch (e) { onError(e); }
            }
            tryOnce();
          });
        }
  
        var sectionEl = document.getElementById('section-six-' + sectionId);
        var scrollyContainer = document.getElementById(containerId);
        var warmupVideo = null;
        var initialized = false;
  
        function onNearViewport() {
          if (initialized) return;
          initialized = true;
  
          addPreloadLink(videoSrc);
          warmupVideo = createWarmupVideo(videoSrc, videoPoster);
          document.body.appendChild(warmupVideo);
  
          loadVideoWithRetries(warmupVideo, 2).then(function () {
            if (window.ScrollyVideo) {
              new ScrollyVideo({
                scrollyVideoContainer: containerId,
                src: videoSrc,
                cover: true,
                sticky: false,
                overflow: true,
              });
            } else {
              var fallback = warmupVideo.cloneNode(true);
              fallback.className = '';
              fallback.style.width = '100%';
              fallback.autoplay = true;
              fallback.loop = true;
              fallback.muted = false;
              scrollyContainer.appendChild(fallback);
              fallback.play().catch(()=>{});
            }
            try { warmupVideo.remove(); } catch(e){}
            warmupVideo = null;
          }).catch(function () {
            if (window.ScrollyVideo) {
              new ScrollyVideo({
                scrollyVideoContainer: containerId,
                src: videoSrc,
                cover: true,
                sticky: false,
                overflow: true,
              });
            }
          });
  
          runInnerFade();
        }
  
        if ('IntersectionObserver' in window && sectionEl) {
          var io = new IntersectionObserver(function (entries) {
            entries.forEach(ent => {
              if (ent.isIntersecting) {
                onNearViewport();
                io.disconnect();
              }
            });
          }, { rootMargin: '250px' });
          io.observe(sectionEl);
        } else {
          onNearViewport();
        }
  
        function runInnerFade() {
          var innerSel = "#section-six-inner-wine-mobile-" + sectionId;
          var overlayEl = document.querySelector(".section-six_content-bottom");
          var innerEl = document.querySelector(innerSel);
          if (window.gsap && window.ScrollTrigger && innerEl) {
            gsap.registerPlugin(ScrollTrigger);
            gsap.set(innerEl, { opacity: 0 });
            gsap.to(innerSel, {
              scrollTrigger: {
                trigger: overlayEl,
                start: 'top 40%',
                end: 'top 25%',
                scrub: false,
                onEnter: () => gsap.to(innerSel, { opacity: 1, duration: 1.2, ease: 'power2.out' }),
                onLeaveBack: () => gsap.to(innerSel, { opacity: 0, duration: 0.6, ease: 'power2.in' })
              }
            });
          }
        }
  
        // Safety: trigger preload if already in view
        try {
          var rect = sectionEl.getBoundingClientRect();
          if (rect.top < window.innerHeight + 250) onNearViewport();
        } catch(e){}
      })();
    </script>
  </section>
  
  {% schema %}
  {
    "name": "Section Six",
    "settings": [],
    "blocks": [],
    "presets": [
      {
        "name": "Section Six",
        "category": "Custom"
      }
    ]
  }
  {% endschema %}
  