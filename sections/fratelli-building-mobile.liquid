{% comment %}
  Video Scrub (GSAP + ScrollTrigger)
  - Pin the media wrapper (stable element) when it reaches top of viewport
  - Scrub the child <video> element's currentTime using the scroll progress
{% endcomment %}

<section id="section-video-scrub-three-{{ section.id }}" class="fratelli-video-scrub-three fratelli-video-scrub-three--{{ section.id }}">
  <div class="fratelli-video-scrub-three__inner">
    <!-- Pinned wrapper (we pin this) -->
    <div class="fratelli-video-scrub-three__media">
      <video
        class="fratelli-video-scrub-three__video"
        playsinline
        muted
        preload="auto"
        aria-hidden="true"
      >
        <source src="https://cdn.shopify.com/videos/c/o/v/9d0d7db685a0498da3add0992dd7b8ea.mp4" type="video/mp4">
      </video>
    </div>

    <!-- Content area -->
    <div class="fratelli-video-scrub-three__content" data-over-content-three>
      <div class="fratelli-video-scrub-three__container" id="jason-{{ section.id }}">
        <div class="fratelli-video-scrub-three__content-inner">
          <h1 id="jason-h1-{{ section.id }}">Explore Range of Fratelli</h1>
          <h2 id="jason-h2-{{ section.id }}">From Akluj's Soil</h2>
          <p id="jason-p-{{ section.id }}">
            Their hands don't just plant vines. they planted a vision. they dont dont follow europe. they carved india into every bottle.
          </p>
          <div style="margin-top: 1.25rem;">
            <button type="button" class="fratelli-video-scrub-three__explore-btn" id="jason-btn-{{ section.id }}">Explore</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .fratelli-video-scrub-three { position: relative; width: 100%; }
    .fratelli-video-scrub-three__inner { position: relative; width: 100%; }

    /* media wrapper */
    .fratelli-video-scrub-three__media { width: 100%; position: relative; overflow: hidden; }

    /* video: fill viewport, cover crop */
    .fratelli-video-scrub-three__video {
      width: 100%;
      height: 100vh;       /* use 100vh (avoid 101vh which can confuse ScrollTrigger) */
      display: block;
      object-fit: cover;
      will-change: transform;
    }

    /* content starts in document flow; we'll overlay it via JS when needed */
    .fratelli-video-scrub-three__content {
      position: relative;
      width: 100%;
      margin-top: 0;
      padding: 20px;
      z-index: 2;
      background: linear-gradient(0deg, #34461A 74.46%, rgba(0, 0, 0, 0) 100%);
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 100%);
        mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 100%);
    }

    .fratelli-video-scrub-three__content-inner { max-width: 56rem; margin-bottom: 2.5rem; }

    .fratelli-video-scrub-three__container h1 {
      font-family: "Utile", sans-serif;
      text-transform: uppercase;
      color: #F4CF80;
      font-size: 48px;
      margin-top: 6rem;
    }
    .fratelli-video-scrub-three__container h2 {
      font-family: "Playfair Display", serif;
      margin-bottom: 1.75rem;
      padding-right: 5rem;
      color: #FFFFF8;
      font-size: 32px;
      font-style: italic;
      letter-spacing: -0.06em;
    }
    .fratelli-video-scrub-three__container p {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding-right: 7rem;
      color: #FFFFF8;
      font-size: 20px;
      letter-spacing: -0.04em;
    }

    .fratelli-video-scrub-three__explore-btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 0.625rem 1.25rem;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
    }

    @media (min-width: 1024px) {
      .fratelli-video-scrub-three__container { flex-direction: row; }
    }

    @media (prefers-reduced-motion: reduce) {
      .fratelli-video-scrub-three__content-panel { transition: none !important; }
    }
  </style>

  <script>
    (function () {
      var root = document.getElementById("section-video-scrub-three-{{ section.id }}");
      if (!root) return;

      var mediaWrap = root.querySelector(".fratelli-video-scrub-three__media"); // pinned element
      var videoEl = root.querySelector(".fratelli-video-scrub-three__video");
      var overContent = root.querySelector("[data-over-content-three]");

      if (!window.gsap || !window.ScrollTrigger) {
        console.warn("GSAP/ScrollTrigger not found. Make sure they are loaded in theme.liquid.");
        return;
      }
      gsap.registerPlugin(ScrollTrigger);

      // Force consistent video height
      try { videoEl.style.height = "100vh"; } catch (e) {}

      // We'll overlay the content while the media is pinned so we can center it if needed.
      // Keep a fallback initialTop percent (where content sits before centering).
      if (overContent) {
        // Set overlay styles (so it's visually above the video while pinned)
        overContent.style.position = "absolute";
        overContent.style.left = "0";
        overContent.style.width = "100%";
        overContent.style.zIndex = "2";
        overContent.style.transform = "translateY(-50vh)";
        // Initialize top (will be corrected on refresh)
      }

      // Helper: safe set currentTime (some browsers may throw if invalid)
      function setVideoTime(t) {
        try {
          // clamp t to [0, duration]
          var dur = videoEl.duration || 0;
          if (dur && isFinite(dur)) {
            videoEl.currentTime = Math.max(0, Math.min(dur, t));
          }
        } catch (e) {
          // ignore write errors (some mobile browsers restrict this in odd states)
        }
      }

      // Main ScrollTrigger: pin the wrapper and scrub progress 0..1
      var mainST = ScrollTrigger.create({
        trigger: mediaWrap,
        start: "top top",
        end: "+=300%",,
        pin: mediaWrap,          // pin the wrapper (not the video)
        pinSpacing: true,
        scrub: true,
        anticipatePin: 1,
        invalidateOnRefresh: true,
        // markers: true, // enable while debugging
        onUpdate: function(self) {
          var p = self.progress; // 0..1 over the pinned area

          // If video duration is ready, map progress to currentTime
          if (videoEl && !isNaN(videoEl.duration) && isFinite(videoEl.duration)) {
            setVideoTime(p * videoEl.duration);
          }
        }
      });

      // Pause video initially and set time 0 when metadata is available
      if (videoEl) {
        function ensureReady() {
          try { videoEl.pause(); } catch (e) {}
          try { videoEl.currentTime = 0; } catch (e) {}
          ScrollTrigger.refresh();
        }
        if (videoEl.readyState >= 2 && !isNaN(videoEl.duration)) {
          ensureReady();
        } else {
          videoEl.addEventListener("loadedmetadata", ensureReady, { once: true });
        }

        // if reduced motion is preferred, do not animate video
        var prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (prefersReduced) {
          try { videoEl.pause(); } catch (e) {}
        }
      }

      // Recompute when resizing viewport
      window.addEventListener("resize", function () {
        ScrollTrigger.refresh();
      });
    })();
  </script>

  {% schema %}
  {
    "name": "Video Scrub Section",
    "settings": [],
    "presets": [
      { "name": "Video Scrub Section" }
    ]
  }
  {% endschema %}
</section>
