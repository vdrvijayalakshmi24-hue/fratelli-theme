{% comment %}
sections/scrolly-video-building-mobile-fixed.liquid
- Duplicated from scrolly-video-three-fixed-2.liquid
- Uses new video source: https://cdn.shopify.com/videos/c/o/v/49f4e96f0c8a43fa90adad4efeaa9e52.mp4
- All class names renamed to prevent conflicts.
{% endcomment %}

<section class="sv-building-mobile-section" id="sv4-building-mobile-{{ section.id }}">
  <style>
    .sv-building-mobile-section {
      position: relative;
      height: 200vh;         /* scroll length */
      overflow: visible;
      isolation: isolate;
      background: #000;      /* safety background so it’s never blank */
    }

    /* Underlay container (we’ll sticky its child video/canvas) */
    .sv4-video-building-mobile {
      position: relative;
      z-index: 1;
      min-height: 100vh;     /* ensure presence even before JS runs */
    }
    /* Fallback/sticky behavior */
    .sv4-video-building-mobile video,
    .sv4-video-building-mobile canvas {
      position: sticky;
      top: 0;
      width: 100%;
      height: 100vh;
      display: block;
      object-fit: cover;
      z-index: 1 !important;
      background: #000;
    }

    /* ---------- Overlay (kept visible; only inner fades) ---------- */
    .fratelli-video-building-mobile-scrub__content {
      position: absolute;
      bottom: 0;
      width: 100%;
      z-index: 10;
      padding: 20px;

      /* DO NOT hide the whole overlay—only fade the inner */
      pointer-events: auto;
      transform: translateY(0);
      display: flex;
      align-items: flex-end;
      text-align: center;
      display: flex;
      justify-content: center;
    }

    .fratelli-video-building-mobile-scrub__content-inner {
      max-width: 56rem;
      margin: 0 auto 2.5rem auto;
      opacity: 0; /* GSAP will fade this in/out */
    }

    .fratelli-video-building-mobile-scrub__container h1 {
      font-family: "Utile", sans-serif; color: #ffffff;
      font-size: 36px; font-weight: 600; margin-top: 6rem;
    }
    .fratelli-video-building-mobile-scrub__container p {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #FFFFF8; font-size: 16px; letter-spacing: -0.04em;
    }
    .fratelli-video-building-mobile-scrub__explore-btn {
      background: #fff; color: #000; border: none; padding: 0.625rem 1.25rem;
      border-radius: 20px; font-weight: 600; cursor: pointer;
    }

    /* Optional “near bottom” styling */
    .fratelli-video-building-mobile-scrub__content.is-section-bottom {
      background: linear-gradient(0deg, #34461A 74.46%, rgba(0, 0, 0, 0) 100%);
      -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 100%);
      mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 100%);
      border-radius: 12px 12px 0 0; padding: 24px 32px;
      -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
      height: 25%;
    }

    @media (max-width: 768px) {
      .fratelli-video-building-mobile-scrub__container h1 { font-size: 28px; margin-top: 3rem; }
      .fratelli-video-building-mobile-scrub__container p { font-size: 16px; padding-right: 0; }
      .fratelli-video-building-mobile-scrub__content.is-section-bottom { padding: 16px 20px; border-radius: 8px 8px 0 0; }
    }
  </style>

  <!-- Underlay -->
  <div id="scrolly-video4-building-mobile-{{ section.id }}" class="sv4-video-building-mobile"></div>

  <!-- Overlay -->
  <div class="fratelli-video-building-mobile-scrub__content" data-over-content id="sv4-overlay-building-mobile-{{ section.id }}">
    <div class="fratelli-video-building-mobile-scrub__container">
      <div class="fratelli-video-building-mobile-scrub__content-inner" id="sv4-inner-building-mobile-{{ section.id }}">
        <h1 id="sv4-h1-building-mobile-{{ section.id }}">Live the wine life</h1>
        <p id="sv4-p1-building-mobile-{{ section.id }}">
          Escape to our estate, where sunrise walks through vineyards, private tastings and starlit dinners create a world steeped in wine and wonder.
        </p>
        <div style="margin-top: 1.25rem;">
          <button type="button" class="fratelli-video-building-mobile-scrub__explore-btn" id="sv4-btn-{{ section.id }}" tabindex="-1">CHECKOUT THE EXPERIENCE</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var sectionId   = "{{ section.id }}";
      var containerId = "scrolly-video4-building-mobile-" + sectionId;
      var overlaySel  = "#sv4-overlay-building-mobile-" + sectionId;
      var innerSel    = "#sv4-inner-building-mobile-" + sectionId;
      var SHOW_THRESHOLD = 0.70, HIDE_THRESHOLD = 0.1;
      var videoSrc = "https://cdn.shopify.com/videos/c/o/v/9d0d7db685a0498da3add0992dd7b8ea.mp4";

      var overlayEl = document.querySelector(overlaySel);
      var innerEl   = document.querySelector(innerSel);
      var holder    = document.getElementById(containerId);

      // --- 1) Try ScrollyVideo; else inject a sticky <video> fallback so the section is never blank ---
      var scrollyInitOk = false;
      try {
        if (window.ScrollyVideo) {
          new ScrollyVideo({
            scrollyVideoContainer: containerId,
            src: videoSrc,
            cover: true,
            onChange: function (progress) {
              if (overlayEl) {
                if (progress >= SHOW_THRESHOLD) {
                  if (!overlayEl.classList.contains('is-section-bottom')) {
                    overlayEl.classList.add('is-section-bottom');
                    var btn = overlayEl.querySelector('button, a'); if (btn) btn.setAttribute('tabindex','0');
                  }
                } else if (progress < HIDE_THRESHOLD) {
                  if (overlayEl.classList.contains('is-section-bottom')) {
                    overlayEl.classList.remove('is-section-bottom');
                    var btn2 = overlayEl.querySelector('button, a'); if (btn2) btn2.setAttribute('tabindex','-1');
                  }
                }
              }
            }
          });
          scrollyInitOk = true;
        }
      } catch (e) {
        console.warn("[SV4] ScrollyVideo error:", e);
      }

      if (!scrollyInitOk && holder) {
        var v = document.createElement('video');
        v.src = videoSrc;
        v.playsInline = true;
        v.muted = true;
        v.autoplay = true;
        v.loop = true;
        v.setAttribute('webkit-playsinline', 'true');
        holder.appendChild(v);
        v.addEventListener('error', function(){ console.warn('[SV4] Fallback video failed to load'); });
      }

      // --- 2) GSAP ScrollTrigger: fade ONLY the inner content (no scrub) ---
      if (window.gsap && window.ScrollTrigger && innerEl) {
        gsap.registerPlugin(ScrollTrigger);
        gsap.set(innerEl, { opacity: 0 });

        gsap.to(innerSel, {
          scrollTrigger: {
            trigger: overlaySel,
            start: 'top 70%',
            end: 'top 25%',
            scrub: false,
            markers: true,
            onEnter: () => {
              gsap.to(innerSel, {
                opacity: 1,
                duration: 1.2,
                ease: 'power2.out'
              });
            },
            onLeaveBack: () => {
              gsap.to(innerSel, {
                opacity: 0,
                duration: 0.6,
                ease: 'power2.in'
              });
            }
          }
        });
      } else {
        console.warn('[SV4] GSAP/ScrollTrigger missing — inner fade skipped.');
      }
    })();
  </script>
</section>
