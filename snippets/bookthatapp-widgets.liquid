{%- comment -%}

BookThatApp Widget Loader

This file is automatically generated. Do not modify. Any modifications will be overwritten.

Contact support@zetya.com if you need assistance.

== Version: 1.2 ==

{%- endcomment -%}


{% assign bookthatapp_config_json = shop.metafields.bookthatapp.config_json %}
{% assign widgets = bookthatapp_config_json.widget_enabled_list %}

{% if product.id or bookthatapp_config_json == blank or widgets contains 'calendar' or widgets contains 'reservation' or widgets contains 'upcoming_event' %}
<script src="/apps/bookthatapp/sdk/v1/js/bta-in-shopify.min.js" defer></script>

{% if widgets contains 'reservation'%}
<script>
  // disable checkout buttons. Reservation widget will define, that it should be available.
  document.querySelectorAll('form[action^="/cart"] [name="checkout"]').forEach(function(checkout) { checkout.disabled = true });
</script>
{% endif %}

<script>
  var productConfig = {},
    productMetafields = '{{ product.metafields.bookthatapp.config }}';
  if (productMetafields != '') {
    productConfig = JSON.parse('{"' + decodeURI(productMetafields).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
  }

  if (productConfig.widget_id) {
    // hide classic booking form if widget id present in product metafields
    document.querySelectorAll('.booking-form').forEach(function(form) {
      form.style.display = 'none';
    });
  }

  window.addEventListener('DOMContentLoaded', function() {
    if (typeof BookThatApp === 'undefined') {
      document.querySelectorAll('form[action^="/cart"] [name="checkout"]').forEach(function(checkout) { checkout.disabled = false });
      return; // uninstalled
    }

    window.BtaConfig = JSON.parse('{{ shop.metafields.bookthatapp.config }}' || '{}')

    var productConfig = {},
      productMetafields = '{{ product.metafields.bookthatapp.config }}';

    if (productMetafields != '') {
      productConfig = JSON.parse('{"' + decodeURI(productMetafields).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
    }

    BtaWidgetLoader.render({
      account: '{{ shop.permanent_domain | split: '.' | first }}',
      hostname: location.hostname,
      appInstalled: true,
      externalId: '{{ product.id }}',
      widgetId: productConfig.widget_id,
      cart: {{ cart | json }},
      shopConfig: BtaConfig,
      onSubmit: function(reservation) {
        BtaConvertReservationToCart.addToCart(reservation, BtaConfig)
      }
    });
  })
</script>
{% endif %}
